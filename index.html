<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>EV Fizio</title>

<!-- App Icons / PWA-ish feel -->
<link rel="icon" type="image/png" href="visockis.jpg">
<link rel="apple-touch-icon" href="visockis.jpg">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="EV Fizio">

<style>
  :root{
    --bg:#f6f7f8;--panel:#fff;--text:#0b0f13;--muted:#5b6470;--accent:#10a37f;--accent2:#0b8a6b;
    --danger:#e5484d;--border:#e3e5e8;--shadow:0 1px 2px rgba(0,0,0,.04),0 8px 24px rgba(0,0,0,.06);--r:16px
  }

  /* Phone-first “app” look */
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:17px/1.5 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial; /* bigger base */
    -webkit-text-size-adjust:100%; /* prevent auto-zooming on inputs iOS */
  }

  /* Narrow, app-like column that fills the phone screen */
  .wrap{
    width:100%;
    max-width:420px;                 /* feels like native app width */
    margin-inline:auto;
    padding:16px;                    /* consistent padding on phones */
  }

  /* On wider screens, breathe a bit more */
  @media (min-width:900px){
    body{font-size:16px}
    .wrap{max-width:860px;padding:clamp(12px,2vw,20px)}
  }

  header{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#10a37f,#72e7c7);
        display:grid;place-items:center;color:#fff;font-weight:800;box-shadow:var(--shadow)}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}

  .panel{background:#fff;border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin:14px 0}
  .panel h2{margin:0 0 12px;font-size:18px}

  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  @media(max-width:700px){.grid.cols-2{grid-template-columns:1fr}} /* stack on phones */

  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],input[type="password"],input[type="date"]{
    width:100%;box-sizing:border-box;background:#fff;border:1px solid var(--border);
    border-radius:12px;padding:13px 14px;font-size:16px
  }

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row>*{flex:1 1 auto}

  .btn{
    appearance:none;border:1px solid transparent;border-radius:12px;padding:12px 14px;
    font-weight:700;font-size:16px;cursor:pointer;transition:.2s transform,.2s background-color;white-space:nowrap
  }
  .btn:active{transform:scale(.98)}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.primary:hover{background:var(--accent2)}
  .btn.neutral{background:#fff;border-color:var(--border)}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.ghost{background:transparent;border-color:var(--border);color:var(--muted)}

  .inline-note{font-size:12px;color:var(--muted)}
  .tools-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}

  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  @media(max-width:700px){.stats{grid-template-columns:1fr}}

  .stat{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .stat .k{font-size:12px;color:var(--muted)}
  .stat .v{font-size:20px;font-weight:700}

  .table{margin-top:10px;border-top:1px solid var(--border)}
  .rowline{
    display:grid;grid-template-columns:1.2fr .9fr .6fr .7fr .6fr auto;
    gap:10px;padding:12px 0;border-bottom:1px solid var(--border);align-items:center
  }
  @media(max-width:900px){.rowline{grid-template-columns:1.2fr .7fr .6fr .6fr .6fr auto}}
  @media(max-width:700px){.rowline{grid-template-columns:1fr;gap:6px}}
  .rowline .ts{font-size:12px;color:var(--muted)}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f0f3f5;color:#223;display:inline-block}

  .empty{padding:18px;text-align:center;color:var(--muted)}

  .modal-backdrop{position:fixed;inset:0;background:rgba(15,18,22,.35);display:none;align-items:flex-end;justify-content:center}
  .modal{width:100%;max-width:560px;background:#fff;border:1px solid var(--border);border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:var(--shadow);padding:14px;transform:translateY(8px)}
  .modal header{margin:0 0 10px 0}
  .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

  .hide{display:none}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">EV</div>
    <div>
      <h1>EV Fizio</h1>
      <div class="sub"></div>
    </div>
  </header>

  <!-- AUTH -->
  <section class="panel" id="authPanel">
    <h2 id="authTitle">Log in</h2>
    <div id="loginView">
      <div class="grid cols-2">
        <div><label for="loginEmail">Email</label><input id="loginEmail" type="text" placeholder="name@example.com" autocomplete="username"></div>
        <div><label for="loginPass">Password</label><input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="loginBtn">Log in</button>
        <button class="btn neutral" id="gotoSignupBtn">Sign up</button>
      </div>
      <div class="inline-note">Uses Supabase Auth (email + password).</div>
    </div>

    <div id="signupView" class="hide">
      <div class="grid cols-2">
        <div><label for="suName">Name</label><input id="suName" type="text" placeholder="Ēriks"></div>
        <div><label for="suSurname">Surname</label><input id="suSurname" type="text" placeholder="Visockis"></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label for="suNick">Nickname (unique)</label><input id="suNick" type="text" placeholder="eriks"></div>
        <div><label for="suEmail">Email</label><input id="suEmail" type="text" placeholder="name@example.com"></div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label for="suPhone">Phone (optional)</label><input id="suPhone" type="text" placeholder="+371 ..."></div>
        <div><label for="suPass">Create password</label><input id="suPass" type="password" placeholder="At least 6 characters"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="signupBtn">Create account</button>
        <button class="btn ghost" id="gotoLoginBtn">Back to login</button>
      </div>
      <div class="inline-note">A profile row is stored in Postgres.</div>
    </div>
  </section>

  <!-- ADD PATIENT -->
  <section class="panel hide" id="addPanel">
    <h2>Add patient</h2>
    <div class="grid cols-2">
      <div><label for="dateInput">Date</label><input id="dateInput" type="date" /></div>
      <div><label for="patientName">Patient name</label><input id="patientName" type="text" placeholder="Patient (optional)" /></div>
    </div>
    <div class="grid cols-2" style="margin-top:10px">
      <div><label for="grossAmount">Clinic amount (EUR)</label><input id="grossAmount" type="number" min="0" step="0.01" placeholder="e.g., 40.00" /></div>
      <div><label for="pct">Your %</label><input id="pct" type="number" min="0" max="100" step="0.1" placeholder="35" /></div>
    </div>
    <div class="grid cols-2" style="margin-top:10px">
      <div><label for="earned">Your earnings (linked)</label><input id="earned" type="number" step="0.01" /></div>
      <div><label for="notes">Notes (optional)</label><input id="notes" type="text" placeholder="cash/card, session type …" /></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="addEntry">Add entry</button>
      <button class="btn ghost" id="logoutBtn" style="flex:0 0 auto">Log out</button>
      <span class="inline-note">Sticky clinic amount & % (per user) are stored in DB.</span>
    </div>
  </section>

  <!-- AUDIT -->
  <section class="panel hide" id="auditPanel">
    <h2>Audit</h2>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <button class="btn neutral" data-range="today">Today</button>
      <button class="btn neutral" data-range="yesterday">Yesterday</button>
      <button class="btn neutral" data-range="thisWeek">This week</button>
      <button class="btn neutral" data-range="lastWeek">Last week</button>
      <button class="btn neutral" data-range="thisMonth">This month</button>
      <button class="btn neutral" data-range="lastMonth">Last month</button>
      <button class="btn neutral" data-range="thisYear">This year</button>
      <button class="btn neutral" data-range="lastYear">Last year</button>
      <button class="btn primary" id="manualOpen">Manual…</button>
    </div>
    <div id="summary" class="stats" style="margin-top:12px"></div>
    <div id="results" class="table"></div>
    <div id="emptyState" class="empty hide">No entries yet for the selected period.</div>
    <div class="tools-row">
      <button class="btn neutral" id="exportCsvBtn" style="flex:0 0 auto">Export CSV</button>
      <span class="inline-note">Exports all entries of the logged-in user.</span>
    </div>
  </section>
</div>

<!-- Manual date modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header><h2 id="modalTitle" style="margin:0">Select a custom period</h2></header>
    <div class="grid cols-2">
      <div><label for="fromDate">From</label><input type="date" id="fromDate"></div>
      <div><label for="toDate">To</label><input type="date" id="toDate"></div>
    </div>
    <div class="footer">
      <button class="btn ghost" id="closeModal">Cancel</button>
      <button class="btn primary" id="applyManual">Apply</button>
    </div>
  </div>
</div>

<!-- Supabase client -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/*** CONFIG ***/
const SUPABASE_URL = 'https://qumdeojxaxqfxzdyflez.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1bWRlb2p4YXhxZnh6ZHlmbGV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjU5MjgsImV4cCI6MjA3Nzg0MTkyOH0.nOpd4eChqNE16US9e8Sbz9yUcKG7t4xXDQr_PPzGGok';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/*** DOM refs / utils / toasts ***/
const qs = s => document.querySelector(s);
const authPanel=qs('#authPanel'), authTitle=qs('#authTitle');
const loginView=qs('#loginView'), signupView=qs('#signupView');
const loginEmail=qs('#loginEmail'), loginPass=qs('#loginPass');
const suName=qs('#suName'), suSurname=qs('#suSurname'), suNick=qs('#suNick'), suEmail=qs('#suEmail'), suPhone=qs('#suPhone'), suPass=qs('#suPass');

const addPanel=qs('#addPanel'), auditPanel=qs('#auditPanel');
const dateInputEl=qs('#dateInput'), patientNameEl=qs('#patientName'), grossAmountEl=qs('#grossAmount'), pctEl=qs('#pct'), earnedEl=qs('#earned'), notesEl=qs('#notes');
const exportCsvBtn=qs('#exportCsvBtn'), logoutBtn=qs('#logoutBtn'), addEntryEl=qs('#addEntry');
const summaryEl=qs('#summary'), resultsEl=qs('#results'), emptyStateEl=qs('#emptyState');

const modalBackdrop=qs('#modalBackdrop'), manualOpen=qs('#manualOpen'), closeModal=qs('#closeModal'), applyManual=qs('#applyManual'), fromDateEl=qs('#fromDate'), toDateEl=qs('#toDate');

function pad(n){return String(n).padStart(2,'0')}
function todayISO(){const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function dateOnlyISO(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function round2(n){return Math.round(n*100)/100}
function clamp(n,min,max){return Math.max(min, Math.min(max,n))}
function fmtTs(iso){if(!iso) return ''; const d=new Date(iso); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
function trunc(s,n){return s && s.length>n ? s.slice(0,n-1)+'…' : (s||'')}
let toastBox; function toast(msg,k='ok'){ if(!toastBox){toastBox=document.createElement('div');toastBox.style.position='fixed';toastBox.style.left='50%';toastBox.style.bottom='24px';toastBox.style.transform='translateX(-50%)';toastBox.style.zIndex='9999';document.body.appendChild(toastBox);}
  const el=document.createElement('div'); el.textContent=msg; el.style.background=k==='warn'?'#fff6e5':'#e9fbf5'; el.style.border='1px solid '+(k==='warn'?'#f0ca6b':'#a7e7d3'); el.style.padding='10px 14px'; el.style.borderRadius='12px'; el.style.boxShadow='0 8px 24px rgba(0,0,0,.08)'; el.style.marginTop='8px'; toastBox.appendChild(el); setTimeout(()=>el.remove(),1800); }

/*** Auth UI switching ***/
qs('#gotoSignupBtn').addEventListener('click',()=>{loginView.classList.add('hide');signupView.classList.remove('hide');authTitle.textContent='Sign up';});
qs('#gotoLoginBtn').addEventListener('click',()=>{signupView.classList.add('hide');loginView.classList.remove('hide');authTitle.textContent='Log in';});

/*** Supabase: signup/login/logout ***/
async function signup(){
  const name = suName.value.trim();
  const surname = suSurname.value.trim();
  const nick = suNick.value.trim();
  const email = suEmail.value.trim();
  const phone = suPhone.value.trim();
  const pass = suPass.value;

  if(!name||!surname||!nick||!email||!pass){ toast('Fill Name, Surname, Nickname, Email, Password','warn'); return; }
  if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ toast('Invalid email','warn'); return; }
  if(pass.length<6){ toast('Password too short','warn'); return; }

  // No manual insert into profiles; trigger will create it.
  const { data, error } = await supabaseClient.auth.signUp({
    email,
    password: pass,
    options: { data: { name, surname, nickname: nick, phone: phone || null } }
  });
  if (error) { toast(error.message, 'warn'); return; }

  toast('Account created. Check your email to confirm (if required).');
  showApp(true);

  suName.value = suSurname.value = suNick.value = suEmail.value = suPhone.value = suPass.value = '';
}

async function login(){
  const email=loginEmail.value.trim(), pass=loginPass.value;
  if(!email||!pass){toast('Enter email & password','warn');return;}
  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password: pass });
  if(error){ toast(error.message,'warn'); return; }
  loginEmail.value=loginPass.value='';
  toast(`Welcome!`);
  showApp(true);
}

async function logout(){
  await supabaseClient.auth.signOut();
  authPanel.classList.remove('hide'); addPanel.classList.add('hide'); auditPanel.classList.add('hide');
  loginView.classList.remove('hide'); signupView.classList.add('hide'); authTitle.textContent='Log in';
  toast('Logged out');
}
qs('#signupBtn').addEventListener('click', signup);
qs('#loginBtn').addEventListener('click', login);
qs('#logoutBtn').addEventListener('click', logout);

/*** Sticky settings ***/
async function getSticky(){
  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user) return { sticky_gross:null, sticky_pct:35 };
  const { data, error } = await supabaseClient.from('user_settings')
    .select('sticky_gross, sticky_pct').eq('user_id', user.id).single();
  if(error){ return { sticky_gross:null, sticky_pct:35 }; }
  return data || { sticky_gross:null, sticky_pct:35 };
}
async function setSticky(gross,pct){
  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user) return;
  await supabaseClient.from('user_settings').upsert(
    { user_id:user.id, sticky_gross: gross ?? null, sticky_pct: pct ?? null },
    { onConflict:'user_id' }
  );
}

/*** Add form default + 3-way linking ***/
function hydrateAddFormDefaults(sticky){
  dateInputEl.value=todayISO();
  grossAmountEl.value = (sticky.sticky_gross ?? '') === null ? '' : sticky.sticky_gross;
  pctEl.value = sticky.sticky_pct ?? 35;
  linkCalc('gross_or_pct');
  earnedEl.value = Number.isFinite(+earnedEl.value)?(+earnedEl.value).toFixed(2):'';
  notesEl.value='';
}
let guard=false;
function linkCalc(trigger){
  if(guard) return; guard=true;
  const gross=parseFloat(grossAmountEl.value), pct=parseFloat(pctEl.value), earned=parseFloat(earnedEl.value);
  if(trigger==='earned' && Number.isFinite(earned) && Number.isFinite(gross) && gross>0){
    pctEl.value = clamp((earned/gross)*100,0,100).toFixed(2);
  } else if((trigger==='gross'||trigger==='pct'||trigger==='gross_or_pct') && Number.isFinite(gross) && Number.isFinite(pct)){
    earnedEl.value=(gross*(pct/100)).toFixed(2);
  }
  guard=false;
}
grossAmountEl.addEventListener('input',()=>linkCalc('gross'));
pctEl.addEventListener('input',()=>linkCalc('pct'));
earnedEl.addEventListener('input',()=>linkCalc('earned'));

/*** Entries CRUD ***/
async function addEntry(){
  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user){ toast('Please log in','warn'); return; }

  const payload = {
    user_id: user.id,
    date: dateInputEl.value || todayISO(),
    patient_name: patientNameEl.value.trim() || null,
    gross: round2(parseFloat(grossAmountEl.value)||0),
    pct: round2(clamp(parseFloat(pctEl.value)||35,0,100)),
    earned: round2(parseFloat(earnedEl.value) || (parseFloat(grossAmountEl.value)||0)*(parseFloat(pctEl.value||35)/100)),
    notes: (notesEl.value.trim()||null)
  };
  if(!(payload.gross>=0)){ toast('Invalid clinic amount','warn'); return; }

  const { error } = await supabaseClient.from('entries').insert(payload);
  if(error){ toast(error.message,'warn'); return; }

  await setSticky(payload.gross, payload.pct);

  patientNameEl.value=''; notesEl.value='';
  const sticky = await getSticky(); hydrateAddFormDefaults(sticky);
  toast('Entry added');
  if(currentRange){ await renderAudit(currentRange.start,currentRange.end); }
}
addEntryEl.addEventListener('click', addEntry);

async function listEntries(fromISO,toISO){
  const { data, error } = await supabaseClient
    .from('entries')
    .select('*')
    .gte('date', fromISO)
    .lte('date', toISO)
    .order('date', { ascending:false })
    .order('created_at', { ascending:false });
  if(error){ toast(error.message,'warn'); return []; }
  return data;
}
async function updateEntry(id, patch){
  patch.updated_at = new Date().toISOString();
  const { error } = await supabaseClient.from('entries').update(patch).eq('id', id);
  if(error){ toast(error.message,'warn'); }
}
async function deleteEntryDB(id){
  const { error } = await supabaseClient.from('entries').delete().eq('id', id);
  if(error){ toast(error.message,'warn'); }
}

/*** Audit ***/
function startOfWeek(d){const dt=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=(dt.getDay()+6)%7;dt.setDate(dt.getDate()-day);return dt;}
function startOfMonth(d){return new Date(d.getFullYear(),d.getMonth(),1)} function endOfMonth(d){return new Date(d.getFullYear(),d.getMonth()+1,0)}
function startOfYear(d){return new Date(d.getFullYear(),0,1)} function endOfYear(d){return new Date(d.getFullYear(),11,31)}
function getRange(kind){const now=new Date(); if(kind==='today'){const s=dateOnlyISO(now);return{start:s,end:s}} if(kind==='yesterday'){const y=new Date(now);y.setDate(y.getDate()-1);const s=dateOnlyISO(y);return{start:s,end:s}}
 if(kind==='thisWeek'){const s=startOfWeek(now),e=new Date(s);e.setDate(s.getDate()+6);return{start:dateOnlyISO(s),end:dateOnlyISO(e)}}
 if(kind==='lastWeek'){const e=startOfWeek(now);e.setDate(e.getDate()-1);const s=new Date(e);s.setDate(e.getDate()-6);return{start:dateOnlyISO(s),end:dateOnlyISO(e)}}
 if(kind==='thisMonth'){const s=startOfMonth(now),e=endOfMonth(now);return{start:dateOnlyISO(s),end:dateOnlyISO(e)}}
 if(kind==='lastMonth'){const lm=new Date(now.getFullYear(),now.getMonth()-1,1);const s=startOfMonth(lm),e=endOfMonth(lm);return{start:dateOnlyISO(s),end:dateOnlyISO(e)}}
 if(kind==='thisYear'){const s=startOfYear(now),e=endOfYear(now);return{start:dateOnlyISO(s),end:dateOnlyISO(e)}}
 if(kind==='lastYear'){const y=now.getFullYear()-1;const s=new Date(y,0,1),e=new Date(y,11,31);return{start:dateOnlyISO(s),end:dateOnlyISO(e)}} return null;}

let currentRange=null;
async function renderAudit(fromISO,toISO){
  currentRange={start:fromISO,end:toISO};
  const entries = await listEntries(fromISO,toISO);
  if(!entries || entries.length===0){ summaryEl.innerHTML=''; resultsEl.innerHTML=''; emptyStateEl.classList.remove('hide'); return; }
  emptyStateEl.classList.add('hide');

  const totalEarned = entries.reduce((s,e)=>s+Number(e.earned||0),0);
  const totalGross  = entries.reduce((s,e)=>s+Number(e.gross||0),0);
  const avg = totalEarned / entries.length;

  summaryEl.innerHTML = `
    <div class="stat"><div class="k">Period</div><div class="v">${fromISO} → ${toISO}</div></div>
    <div class="stat"><div class="k">Total earned</div><div class="v">€ ${totalEarned.toFixed(2)}</div></div>
    <div class="stat"><div class="k">Patients</div><div class="v">${entries.length} <span class="pill">avg € ${avg.toFixed(2)}</span></div></div>
  `;

  resultsEl.innerHTML='';
  for(const e of entries){
    const row=document.createElement('div'); row.className='rowline'; row.dataset.id=e.id;
    row.innerHTML = `
      <div><div><strong>${escapeHtml(e.patient_name||'—')}</strong></div>
      <div class="ts">${e.date} · created ${fmtTs(e.created_at)}${e.updated_at?' · updated '+fmtTs(e.updated_at):''}</div></div>
      <div>Clinic: <strong>€ ${Number(e.gross).toFixed(2)}</strong></div>
      <div>%: <strong>${Number(e.pct).toFixed(2)}%</strong></div>
      <div>You: <strong>€ ${Number(e.earned).toFixed(2)}</strong></div>
      <div><span class="pill" title="${escapeHtml(e.notes||'')}">${e.notes?escapeHtml(trunc(e.notes,22)):'No notes'}</span></div>
      <div class="row" style="gap:6px;justify-content:flex-end">
        <button class="btn neutral editBtn">Edit</button>
        <button class="btn danger deleteBtn">Delete</button>
      </div>`;
    resultsEl.appendChild(row);

    row.addEventListener('click', async (ev)=>{
      const t=ev.target;
      if(t.matches('.deleteBtn')){
        if(confirm('Delete this entry?')){ await deleteEntryDB(e.id); row.remove(); await renderAudit(fromISO,toISO); toast('Entry deleted'); }
      }
      if(t.matches('.editBtn')){ enterEditMode(row,e); }
      if(t.matches('.saveBtn')){ await saveEditRow(row,e.id); }
      if(t.matches('.cancelBtn')){ exitEditMode(row,e); }
    });
  }
}
function enterEditMode(row,e){
  row.innerHTML = `
    <div><input class="in-patientName" type="text" value="${escapeHtml(e.patient_name||'').replace(/"/g,'&quot;')}" />
      <div class="ts">${e.date} · created ${fmtTs(e.created_at)}${e.updated_at?' · updated '+fmtTs(e.updated_at):''}</div></div>
    <div><input class="in-gross" type="number" step="0.01" min="0" value="${Number(e.gross).toFixed(2)}" /></div>
    <div><input class="in-pct" type="number" step="0.01" min="0" max="100" value="${Number(e.pct).toFixed(2)}" /></div>
    <div><input class="in-earned" type="number" step="0.01" min="0" value="${Number(e.earned).toFixed(2)}" /></div>
    <div><input class="in-notes" type="text" value="${escapeHtml(e.notes||'').replace(/"/g,'&quot;')}" /></div>
    <div class="row" style="gap:6px;justify-content:flex-end">
      <button class="btn primary saveBtn">Save</button>
      <button class="btn neutral cancelBtn">Cancel</button>
    </div>`;
  wireRowLinking(row);
}
function exitEditMode(row,e){
  row.innerHTML = `
    <div><div><strong>${escapeHtml(e.patient_name||'—')}</strong></div>
    <div class="ts">${e.date} · created ${fmtTs(e.created_at)}${e.updated_at?' · updated '+fmtTs(e.updated_at):''}</div></div>
    <div>Clinic: <strong>€ ${Number(e.gross).toFixed(2)}</strong></div>
    <div>%: <strong>${Number(e.pct).toFixed(2)}%</strong></div>
    <div>You: <strong>€ ${Number(e.earned).toFixed(2)}</strong></div>
    <div><span class="pill" title="${escapeHtml(e.notes||'')}">${e.notes?escapeHtml(trunc(e.notes,22)):'No notes'}</span></div>
    <div class="row" style="gap:6px;justify-content:flex-end">
      <button class="btn neutral editBtn">Edit</button>
      <button class="btn danger deleteBtn">Delete</button>
    </div>`;
}
function wireRowLinking(row){
  let g=row.querySelector('.in-gross'), p=row.querySelector('.in-pct'), y=row.querySelector('.in-earned'); let guard=false;
  function link(trigger){ if(guard) return; guard=true;
    const gross=parseFloat(g.value), pct=parseFloat(p.value), earned=parseFloat(y.value);
    if(trigger==='earned' && Number.isFinite(earned) && Number.isFinite(gross) && gross>0){ p.value = clamp((earned/gross)*100,0,100).toFixed(2); }
    else if((trigger==='gross'||trigger==='pct') && Number.isFinite(gross) && Number.isFinite(pct)){ y.value = (gross*(pct/100)).toFixed(2); }
    guard=false;
  }
  g.addEventListener('input',()=>link('gross')); p.addEventListener('input',()=>link('pct')); y.addEventListener('input',()=>link('earned'));
}
async function saveEditRow(row,id){
  const patientName=row.querySelector('.in-patientName').value.trim();
  const gross=parseFloat(row.querySelector('.in-gross').value);
  let pct=parseFloat(row.querySelector('.in-pct').value);
  let earned=parseFloat(row.querySelector('.in-earned').value);
  const notes=row.querySelector('.in-notes').value.trim();
  if(!Number.isFinite(gross)||gross<0){toast('Invalid clinic amount','warn');return;}
  if(!Number.isFinite(pct)){ if(Number.isFinite(earned)&&gross>0) pct=(earned/gross)*100; else pct=35; }
  pct=clamp(pct,0,100);
  if(!Number.isFinite(earned)) earned=+(gross*(pct/100)).toFixed(2);
  await updateEntry(id,{ patient_name:patientName||null, gross:round2(gross), pct:round2(pct), earned:round2(earned), notes:notes||null });
  toast('Entry updated');
  const rng=currentRange; if(rng) await renderAudit(rng.start,rng.end);
}

/*** Audit buttons & modal ***/
qs('#auditPanel').addEventListener('click',async e=>{const btn=e.target.closest('button[data-range]'); if(!btn) return; const r=getRange(btn.dataset.range); if(r) await renderAudit(r.start,r.end);});
manualOpen.addEventListener('click',()=>{const d=new Date(); fromDateEl.value=dateOnlyISO(new Date(d.getFullYear(),d.getMonth(),1)); toDateEl.value=todayISO(); openModal();});
closeModal.addEventListener('click',closeModalFn);
applyManual.addEventListener('click',async ()=>{const f=fromDateEl.value,t=toDateEl.value; if(!f||!t||f>t){toast('Choose a valid period','warn');return;} closeModalFn(); await renderAudit(f,t);});
function openModal(){modalBackdrop.style.display='flex';modalBackdrop.setAttribute('aria-hidden','false');}
function closeModalFn(){modalBackdrop.style.display='none';modalBackdrop.setAttribute('aria-hidden','true');}

/*** CSV Export ***/
exportCsvBtn.addEventListener('click', async ()=>{
  const { data: { user } } = await supabaseClient.auth.getUser();
  if(!user){ toast('Log in to export','warn'); return; }
  const { data, error } = await supabaseClient.from('entries').select('*').order('date',{ascending:false});
  if(error){ toast(error.message,'warn'); return; }
  if(!data.length){ toast('No data to export','warn'); return; }
  const header=['id','date','created_at','updated_at','patient_name','gross','pct','earned','notes'];
  const csv=[header.join(',')].concat(
    data.map(e=>[e.id,e.date,e.created_at||'',e.updated_at||'',(e.patient_name||'').replaceAll('"','""'),
      Number(e.gross).toFixed(2),Number(e.pct).toFixed(2),Number(e.earned).toFixed(2),(e.notes||'').replaceAll('"','""')]
      .map(v=>`"${String(v)}"`).join(','))
  ).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ev-fizio.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/*** Show app for current user ***/
async function showApp(scrollToAdd=false){
  const { data:{ user } } = await supabaseClient.auth.getUser();
  if(!user){
    authPanel.classList.remove('hide'); addPanel.classList.add('hide'); auditPanel.classList.add('hide'); return;
  }
  authPanel.classList.add('hide'); addPanel.classList.remove('hide'); auditPanel.classList.remove('hide');
  const sticky = await getSticky(); hydrateAddFormDefaults(sticky);
  const rng=getRange('thisMonth'); await renderAudit(rng.start,rng.end);
  if(scrollToAdd){ setTimeout(()=>addPanel.scrollIntoView({behavior:'smooth',block:'start'}),100); }
}

/*** Initial load ***/
(async function init(){ await showApp(); })();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>EV Fizio — Therapist Tracker</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#f6f7f8; --panel:#ffffff; --text:#0b0f13; --muted:#5b6470;
    --accent:#10a37f; --accent-2:#0b8a6b; --danger:#e5484d; --border:#e3e5e8;
    --shadow: 0 1px 2px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
    --radius:16px;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
  .wrap{max-width:860px;margin-inline:auto;padding:clamp(12px,2vw,20px)}
  header{display:flex;align-items:center;gap:12px;margin:8px 0 16px}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#10a37f,#72e7c7);
    display:grid;place-items:center;color:white;font-weight:800;box-shadow:var(--shadow)}
  h1{font-size:clamp(18px,2.4vw,24px);margin:0}
  .sub{color:var(--muted);font-size:14px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
    box-shadow:var(--shadow);padding:16px;margin:14px 0}
  .panel h2{font-size:clamp(16px,2vw,18px);margin:0 0 12px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:700px){.grid.cols-2{grid-template-columns:1fr}}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"],input[type="number"],input[type="date"],textarea,select{
    width:100%;box-sizing:border-box;background:#fff;color:var(--text);
    border:1px solid var(--border);border-radius:12px;padding:12px;outline:none}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row>*{flex:1 1 auto}
  .btn{appearance:none;border:1px solid transparent;border-radius:12px;
    padding:10px 14px;font-weight:600;cursor:pointer;transition:.2s transform,.2s background-color;white-space:nowrap}
  .btn:active{transform:scale(0.98)}
  .btn.primary{background:var(--accent);color:#fff}.btn.primary:hover{background:var(--accent-2)}
  .btn.neutral{background:#fff;border-color:var(--border);color:var(--text)}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.ghost{background:transparent;border-color:var(--border);color:var(--muted)}
  .inline-note{font-size:12px;color:var(--muted)}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px}
  @media (max-width:700px){.stats{grid-template-columns:1fr}}
  .stat{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
  .stat .k{font-size:12px;color:var(--muted)} .stat .v{font-size:20px;font-weight:700}
  .table{margin-top:10px;border-top:1px solid var(--border)}
  .rowline{display:grid;grid-template-columns:1.2fr .9fr .6fr .7fr .6fr auto;gap:10px;
    padding:12px 0;border-bottom:1px solid var(--border);align-items:center}
  @media (max-width:900px){.rowline{grid-template-columns:1.2fr .7fr .6fr .6fr .6fr auto}}
  @media (max-width:700px){.rowline{grid-template-columns:1fr;gap:6px}}
  .rowline .ts{font-size:12px;color:var(--muted)}
  .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f0f3f5;color:#223;display:inline-block}
  .empty{padding:18px;text-align:center;color:var(--muted)}
  .modal-backdrop{position:fixed;inset:0;background:rgba(15,18,22,0.35);display:none;align-items:flex-end;justify-content:center}
  .modal{width:100%;max-width:560px;background:var(--panel);border:1px solid var(--border);
    border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:var(--shadow);padding:14px;transform:translateY(8px)}
  .modal header{margin:0 0 10px 0}
  .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .hide{display:none}.right{margin-left:auto}
  .tools-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">EV</div>
      <div>
        <h1>EV Fizio — Therapist Tracker</h1>
        <div class="sub">Track patients & earnings safely on your device. Mobile-first, refresh-proof.</div>
      </div>
      <div class="right"></div>
    </header>

    <!-- Therapist profile (Login) -->
    <section class="panel" id="therapistPanel">
      <h2>Therapist</h2>
      <div class="grid cols-2">
        <div>
          <label for="therapistName">Therapist name</label>
          <input id="therapistName" type="text" placeholder="Ēriks Visockis" />
        </div>
        <div>
          <label for="therapistId">Therapist ID (unikāla daļa no personas koda vai ko citu)</label>
          <input id="therapistId" type="text" placeholder="e.g., EV-1992-0412" />
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label for="defaultPct">Default payout %</label>
          <input id="defaultPct" type="number" step="0.1" min="0" max="100" placeholder="35" />
          <div class="inline-note">Usual share for this therapist (e.g., 35%).</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="loginBtn">Log in</button>
        <span class="inline-note">Entries are filtered to the active therapist only.</span>
      </div>
    </section>

    <!-- Add patient entry -->
    <section class="panel" id="addPanel">
      <h2>Add patient</h2>
      <div class="grid cols-2">
        <div>
          <label for="dateInput">Date</label>
          <input id="dateInput" type="date" />
        </div>
        <div>
          <label for="patientName">Patient name</label>
          <input id="patientName" type="text" placeholder="Patient name (optional)" />
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label for="grossAmount">Clinic amount (EUR)</label>
          <input id="grossAmount" type="number" min="0" step="0.01" placeholder="e.g., 40.00" />
        </div>
        <div>
          <label for="pct">Therapist %</label>
          <input id="pct" type="number" min="0" max="100" step="0.1" placeholder="35" />
        </div>
      </div>

      <div class="grid cols-2" style="margin-top:10px">
        <div>
          <label for="earned">Your earnings (auto-linked)</label>
          <input id="earned" type="number" step="0.01" />
        </div>
        <div>
          <label for="notes">Notes (optional)</label>
          <input id="notes" type="text" placeholder="E.g., cash/card, session type …" />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="addEntry">Add entry</button>
        <span class="inline-note">Writes to a local dataset per therapist.</span>
      </div>
    </section>

    <!-- Audit results -->
    <section class="panel" id="auditPanel">
      <h2>Audit</h2>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <button class="btn neutral" data-range="today">Today</button>
        <button class="btn neutral" data-range="yesterday">Yesterday</button>
        <button class="btn neutral" data-range="thisWeek">This week</button>
        <button class="btn neutral" data-range="lastWeek">Last week</button>
        <button class="btn neutral" data-range="thisMonth">This month</button>
        <button class="btn neutral" data-range="lastMonth">Last month</button>
        <button class="btn neutral" data-range="thisYear">This year</button>
        <button class="btn neutral" data-range="lastYear">Last year</button>
        <button class="btn primary" id="manualOpen">Manual…</button>
      </div>

      <div id="summary" class="stats" style="margin-top:12px"></div>
      <div id="results" class="table"></div>
      <div id="emptyState" class="empty hide">No entries yet for the selected period.</div>

      <div class="tools-row">
        <button class="btn neutral" id="exportCsvBtn" style="flex:0 0 auto">Export CSV</button>
        <span class="inline-note">Exports all entries of the active therapist.</span>
      </div>
    </section>
  </div>

  <!-- Modal: manual range -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header><h2 id="modalTitle" style="margin:0">Select a custom period</h2></header>
      <div class="grid cols-2">
        <div><label for="fromDate">From</label><input type="date" id="fromDate"></div>
        <div><label for="toDate">To</label><input type="date" id="toDate"></div>
      </div>
      <div class="footer">
        <button class="btn ghost" id="closeModal">Cancel</button>
        <button class="btn primary" id="applyManual">Apply</button>
      </div>
    </div>
  </div>

<script>
/* ======================= Persistence & State ======================= */
const STORAGE_KEY = 'evfizio_tracker_v2';

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return { therapists:{}, entries:[], currentTherapistId:null, lastInputs:{} };
    const parsed = JSON.parse(raw);
    parsed.therapists ??= {};
    parsed.entries ??= [];
    parsed.currentTherapistId ??= null;
    parsed.lastInputs ??= {}; // per-therapist: {gross, pct}
    return parsed;
  }catch(e){
    console.error('Load state error', e);
    return { therapists:{}, entries:[], currentTherapistId:null, lastInputs:{} };
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
let state = loadState();

/* ======================= Elements ======================= */
const therapistNameEl = document.getElementById('therapistName');
const therapistIdEl   = document.getElementById('therapistId');
const defaultPctEl    = document.getElementById('defaultPct');
const loginBtn        = document.getElementById('loginBtn');

const dateInputEl   = document.getElementById('dateInput');
const patientNameEl = document.getElementById('patientName');
const grossAmountEl = document.getElementById('grossAmount');
const pctEl         = document.getElementById('pct');
const earnedEl      = document.getElementById('earned');
const notesEl       = document.getElementById('notes');
const addEntryEl    = document.getElementById('addEntry');

const exportCsvBtn  = document.getElementById('exportCsvBtn');

const summaryEl = document.getElementById('summary');
const resultsEl = document.getElementById('results');
const emptyStateEl = document.getElementById('emptyState');

const modalBackdrop = document.getElementById('modalBackdrop');
const manualOpen = document.getElementById('manualOpen');
const closeModal = document.getElementById('closeModal');
const applyManual = document.getElementById('applyManual');
const fromDateEl = document.getElementById('fromDate');
const toDateEl = document.getElementById('toDate');

const addPanel = document.getElementById('addPanel');

/* ======================= Helpers ======================= */
function pad(n){ return String(n).padStart(2,'0'); }
function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function dateOnlyISO(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function round2(n){ return Math.round(n*100)/100; }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function fmtTs(iso){ if(!iso) return ''; const d=new Date(iso);
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function trunc(s, n){ return s && s.length>n ? s.slice(0,n-1)+'…' : (s||''); }
function toast(msg, kind='ok'){
  if(!window._toastBox){
    const box = document.createElement('div');
    box.style.position='fixed'; box.style.left='50%'; box.style.bottom='24px';
    box.style.transform='translateX(-50%)'; box.style.zIndex='9999';
    document.body.appendChild(box);
    window._toastBox = box;
  }
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.background = kind==='warn' ? '#fff6e5' : '#e9fbf5';
  el.style.border = '1px solid ' + (kind==='warn' ? '#f0ca6b' : '#a7e7d3');
  el.style.color = '#0b0f13';
  el.style.padding = '10px 14px';
  el.style.borderRadius = '12px';
  el.style.boxShadow = '0 8px 24px rgba(0,0,0,0.08)';
  el.style.marginTop = '8px';
  window._toastBox.appendChild(el);
  setTimeout(()=>{ el.remove(); }, 1800);
}

/* ======================= Login & Therapist ======================= */
function hydrateTherapistFormFromActive(){
  const tid = state.currentTherapistId;
  const t = tid ? state.therapists[tid] : null;
  therapistNameEl.value = t?.name || '';
  therapistIdEl.value   = tid || '';
  defaultPctEl.value    = t?.defaultPct ?? '';
}
function ensureTherapist(id, name, defaultPct){
  if(!state.therapists[id]){
    state.therapists[id] = { name, defaultPct };
  }else{
    state.therapists[id].name = name;
    state.therapists[id].defaultPct = defaultPct;
  }
}
loginBtn.addEventListener('click', ()=>{
  const name = therapistNameEl.value.trim();
  const id   = therapistIdEl.value.trim();
  let dp     = parseFloat(defaultPctEl.value);
  if(!name || !id){ toast('Enter therapist name and ID', 'warn'); return; }
  if(!Number.isFinite(dp)) dp = 35;
  dp = clamp(dp,0,100);

  ensureTherapist(id, name, dp);
  state.currentTherapistId = id;
  saveState();
  hydrateAddFormDefaults();
  // Scroll to Add patient
  addPanel.scrollIntoView({behavior:'smooth', block:'start'});
  // Default render range
  const rng = getRange('thisMonth'); renderAudit(rng.start, rng.end);
  toast(`Logged in as ${name}`);
});

/* If already logged in, auto-scroll to Add patient */
window.addEventListener('load', ()=>{
  hydrateTherapistFormFromActive();
  if(state.currentTherapistId){
    hydrateAddFormDefaults();
    setTimeout(()=> addPanel.scrollIntoView({behavior:'smooth', block:'start'}), 150);
  }
  const rng = getRange('thisMonth'); renderAudit(rng.start, rng.end);
});

/* ======================= Add Form Defaults & Sticky values ======================= */
function hydrateAddFormDefaults(){
  dateInputEl.value = todayISO();
  const tid = state.currentTherapistId;
  const t = tid ? state.therapists[tid] : null;

  // sticky values per therapist
  const last = state.lastInputs[tid] || {};
  const lastGross = Number.isFinite(+last.gross) ? +last.gross : '';
  const lastPct   = Number.isFinite(+last.pct) ? +last.pct : (t?.defaultPct ?? 35);

  grossAmountEl.value = lastGross;
  pctEl.value         = lastPct;
  // compute earned if possible
  updateLinkedValues('gross_or_pct');
  earnedEl.value = Number.isFinite(+earnedEl.value) ? (+earnedEl.value).toFixed(2) : '';
  notesEl.value = '';
}

/* ======================= Linked inputs (mutual updates) ======================= */
let linkingGuard = false;
function updateLinkedValues(trigger){
  if(linkingGuard) return;
  linkingGuard = true;

  const gross = parseFloat(grossAmountEl.value);
  const pct   = parseFloat(pctEl.value);
  const earned= parseFloat(earnedEl.value);

  if(trigger==='earned' && Number.isFinite(earned) && Number.isFinite(gross) && gross>0){
    // earned changed -> recompute pct
    pctEl.value = clamp((earned / gross) * 100, 0, 100).toFixed(2);
  } else if((trigger==='gross' || trigger==='pct' || trigger==='gross_or_pct') && Number.isFinite(gross) && Number.isFinite(pct)){
    // gross or pct changed -> recompute earned
    earnedEl.value = (gross * (pct/100)).toFixed(2);
  } else if(trigger==='gross' && Number.isFinite(earned) && Number.isFinite(gross) && gross>0 && !Number.isFinite(pct)){
    // fallback: recompute pct if pct missing but earned present
    pctEl.value = clamp((earned / gross) * 100, 0, 100).toFixed(2);
  }

  linkingGuard = false;
}

// Attach listeners
grossAmountEl.addEventListener('input', ()=> updateLinkedValues('gross'));
pctEl.addEventListener('input',         ()=> updateLinkedValues('pct'));
earnedEl.addEventListener('input',      ()=> updateLinkedValues('earned'));

/* ======================= Add Entry ======================= */
function uid(){ return Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,8); }
addEntryEl.addEventListener('click', ()=>{
  const tid = state.currentTherapistId;
  if(!tid){ toast('Please log in first', 'warn'); return; }
  const t = state.therapists[tid];
  const dt = dateInputEl.value || todayISO();
  const name = patientNameEl.value.trim();

  const gross = parseFloat(grossAmountEl.value);
  let pct = parseFloat(pctEl.value);
  let earned = parseFloat(earnedEl.value);

  if(!Number.isFinite(gross) || gross<0){ toast('Enter a valid clinic amount', 'warn'); return; }
  if(!Number.isFinite(pct)) pct = t?.defaultPct ?? 35;
  pct = clamp(pct,0,100);
  if(!Number.isFinite(earned)) earned = +(gross * (pct/100)).toFixed(2);

  const entry = {
    id: uid(),
    therapistId: tid,
    therapistName: t?.name || '',
    date: dt,
    createdAt: new Date().toISOString(),
    updatedAt: null,
    patientName: name,
    gross: round2(gross),
    pct: round2(pct),
    earned: round2(earned),
    notes: notesEl.value.trim()
  };
  state.entries.push(entry);

  // remember sticky inputs per therapist
  state.lastInputs[tid] = { gross: entry.gross, pct: entry.pct };
  saveState();

  // clear patient row but keep sticky defaults
  patientNameEl.value = '';
  notesEl.value = '';
  hydrateAddFormDefaults();

  toast('Entry added');

  // refresh current audit
  if(currentRange){ renderAudit(currentRange.start, currentRange.end); }
});

/* ======================= Audit Period Helpers ======================= */
function startOfWeek(d){ const date=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=(date.getDay()+6)%7; date.setDate(date.getDate()-day); return date; }
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function startOfYear(d){ return new Date(d.getFullYear(), 0, 1); }
function endOfYear(d){ return new Date(d.getFullYear(), 11, 31); }
function getRange(kind){
  const now=new Date();
  if(kind==='today'){ const s=dateOnlyISO(now); return {start:s,end:s}; }
  if(kind==='yesterday'){ const y=new Date(now); y.setDate(y.getDate()-1); const s=dateOnlyISO(y); return {start:s,end:s}; }
  if(kind==='thisWeek'){ const s=startOfWeek(now), e=new Date(s); e.setDate(s.getDate()+6); return {start:dateOnlyISO(s), end:dateOnlyISO(e)}; }
  if(kind==='lastWeek'){ const e=startOfWeek(now); e.setDate(e.getDate()-1); const s=new Date(e); s.setDate(e.getDate()-6); return {start:dateOnlyISO(s), end:dateOnlyISO(e)}; }
  if(kind==='thisMonth'){ const s=startOfMonth(now), e=endOfMonth(now); return {start:dateOnlyISO(s), end:dateOnlyISO(e)}; }
  if(kind==='lastMonth'){ const lm=new Date(now.getFullYear(), now.getMonth()-1, 1); const s=startOfMonth(lm), e=endOfMonth(lm); return {start:dateOnlyISO(s), end:dateOnlyISO(e)}; }
  if(kind==='thisYear'){ const s=startOfYear(now), e=endOfYear(now); return {start:dateOnlyISO(s), end:dateOnlyISO(e)}; }
  if(kind==='lastYear'){ const y=now.getFullYear()-1; const s=new Date(y,0,1), e=new Date(y,11,31); return {start:dateOnlyISO(s), end:dateOnlyISO(e)}; }
  return null;
}

/* ======================= Audit Rendering ======================= */
let currentRange = null;

function renderAudit(fromISO, toISO){
  currentRange = {start: fromISO, end: toISO};
  const tid = state.currentTherapistId;
  const entries = state.entries
    .filter(e => e.therapistId === tid)
    .filter(e => e.date >= fromISO && e.date <= toISO)
    .sort((a,b)=> (b.date.localeCompare(a.date) || (b.createdAt||'').localeCompare(a.createdAt||'')));

  if(entries.length===0){
    summaryEl.innerHTML = '';
    resultsEl.innerHTML = '';
    emptyStateEl.classList.remove('hide');
    return;
  } else emptyStateEl.classList.add('hide');

  const totalEarned = entries.reduce((s,e)=> s + (e.earned||0), 0);
  const totalGross  = entries.reduce((s,e)=> s + (e.gross ||0), 0);
  const avgPerPatient = entries.length ? (totalEarned/entries.length) : 0;

  summaryEl.innerHTML = `
    <div class="stat"><div class="k">Period</div><div class="v">${fromISO} → ${toISO}</div></div>
    <div class="stat"><div class="k">Total earned</div><div class="v">€ ${totalEarned.toFixed(2)}</div></div>
    <div class="stat"><div class="k">Patients</div><div class="v">${entries.length} <span class="pill" title="Average per patient">avg € ${avgPerPatient.toFixed(2)}</span></div></div>
  `;

  resultsEl.innerHTML = '';
  for(const e of entries){
    const row = document.createElement('div');
    row.className = 'rowline';
    row.dataset.id = e.id;
    row.innerHTML = renderRowView(e);
    resultsEl.appendChild(row);

    // Row button handlers
    row.addEventListener('click', (ev)=>{
      const t = ev.target;
      if(t.matches('.editBtn')) enterEditMode(e.id);
      if(t.matches('.deleteBtn')) deleteEntry(e.id);
      if(t.matches('.saveBtn')) saveEdit(e.id);
      if(t.matches('.cancelBtn')) cancelEdit(e.id);
    });
  }
}

function renderRowView(e){
  return `
    <div>
      <div><strong>${escapeHtml(e.patientName || '—')}</strong></div>
      <div class="ts">${e.date} · created ${fmtTs(e.createdAt)}${e.updatedAt ? ' · updated '+fmtTs(e.updatedAt):''}</div>
    </div>
    <div>Clinic: <strong>€ ${e.gross.toFixed(2)}</strong></div>
    <div>%: <strong>${e.pct.toFixed(2)}%</strong></div>
    <div>You: <strong>€ ${e.earned.toFixed(2)}</strong></div>
    <div><span class="pill" title="${escapeHtml(e.notes||'')}">${e.notes ? escapeHtml(trunc(e.notes,22)) : 'No notes'}</span></div>
    <div class="row" style="gap:6px;justify-content:flex-end">
      <button class="btn neutral editBtn">Edit</button>
      <button class="btn danger deleteBtn">Delete</button>
    </div>
  `;
}

function renderRowEdit(e){
  return `
    <div>
      <input class="in-patientName" type="text" value="${escapeAttr(e.patientName||'')}" />
      <div class="ts">${e.date} · created ${fmtTs(e.createdAt)}${e.updatedAt ? ' · updated '+fmtTs(e.updatedAt):''}</div>
    </div>
    <div><input class="in-gross" type="number" step="0.01" min="0" value="${e.gross.toFixed(2)}" /></div>
    <div><input class="in-pct" type="number" step="0.01" min="0" max="100" value="${e.pct.toFixed(2)}" /></div>
    <div><input class="in-earned" type="number" step="0.01" min="0" value="${e.earned.toFixed(2)}" /></div>
    <div><input class="in-notes" type="text" value="${escapeAttr(e.notes||'')}" /></div>
    <div class="row" style="gap:6px;justify-content:flex-end">
      <button class="btn primary saveBtn">Save</button>
      <button class="btn neutral cancelBtn">Cancel</button>
    </div>
  `;
}

function enterEditMode(id){
  const row = resultsEl.querySelector(`.rowline[data-id="${id}"]`);
  const e = state.entries.find(x=>x.id===id);
  if(row && e){
    row.innerHTML = renderRowEdit(e);
    wireRowLinkedInputs(row); // enable mutual linking inside the row
  }
}
function cancelEdit(id){
  const row = resultsEl.querySelector(`.rowline[data-id="${id}"]`);
  const e = state.entries.find(x=>x.id===id);
  if(row && e){ row.innerHTML = renderRowView(e); }
}

function wireRowLinkedInputs(row){
  let guard=false;
  const g=row.querySelector('.in-gross');
  const p=row.querySelector('.in-pct');
  const y=row.querySelector('.in-earned');
  function link(trigger){
    if(guard) return; guard=true;
    const gross=parseFloat(g.value), pct=parseFloat(p.value), earned=parseFloat(y.value);
    if(trigger==='earned' && Number.isFinite(earned) && Number.isFinite(gross) && gross>0){
      p.value = clamp((earned/gross)*100,0,100).toFixed(2);
    }else if((trigger==='gross'||trigger==='pct') && Number.isFinite(gross) && Number.isFinite(pct)){
      y.value = (gross*(pct/100)).toFixed(2);
    }
    guard=false;
  }
  g.addEventListener('input', ()=>link('gross'));
  p.addEventListener('input', ()=>link('pct'));
  y.addEventListener('input', ()=>link('earned'));
}

function saveEdit(id){
  const idx = state.entries.findIndex(x=>x.id===id);
  if(idx<0) return;
  const row = resultsEl.querySelector(`.rowline[data-id="${id}"]`);
  const e = state.entries[idx];

  const patientName = row.querySelector('.in-patientName').value.trim();
  const gross = parseFloat(row.querySelector('.in-gross').value);
  let pct = parseFloat(row.querySelector('.in-pct').value);
  let earned = parseFloat(row.querySelector('.in-earned').value);
  const notes = row.querySelector('.in-notes').value.trim();

  if(!Number.isFinite(gross) || gross<0){ toast('Invalid clinic amount', 'warn'); return; }
  if(!Number.isFinite(pct)){ // recompute from earned if needed
    if(Number.isFinite(earned) && gross>0) pct = (earned/gross)*100;
    else pct = 35;
  }
  pct = clamp(pct,0,100);
  if(!Number.isFinite(earned)) earned = +(gross * (pct/100)).toFixed(2);

  e.patientName = patientName;
  e.gross = round2(gross);
  e.pct = round2(pct);
  e.earned = round2(earned);
  e.notes = notes;
  e.updatedAt = new Date().toISOString();

  saveState(state);
  row.innerHTML = renderRowView(e);
  renderAudit(currentRange.start, currentRange.end);
  toast('Entry updated');
}

function deleteEntry(id){
  if(!confirm('Delete this entry? This cannot be undone.')) return;
  const idx = state.entries.findIndex(x=>x.id===id);
  if(idx<0) return;
  state.entries.splice(idx,1);
  saveState(state);
  const row = resultsEl.querySelector(`.rowline[data-id="${id}"]`);
  if(row) row.remove();
  if(currentRange){ renderAudit(currentRange.start, currentRange.end); }
  toast('Entry deleted');
}

/* ======================= Audit Buttons & Modal ======================= */
document.getElementById('auditPanel').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-range]');
  if(!btn) return;
  const range = getRange(btn.dataset.range);
  if(range){ renderAudit(range.start, range.end); }
});
manualOpen.addEventListener('click', ()=>{
  const d = new Date();
  fromDateEl.value = dateOnlyISO(new Date(d.getFullYear(), d.getMonth(), 1));
  toDateEl.value = todayISO();
  openModal();
});
closeModal.addEventListener('click', closeModalFn);
applyManual.addEventListener('click', ()=>{
  const f = fromDateEl.value; const t = toDateEl.value;
  if(!f || !t || f>t){ toast('Choose a valid period', 'warn'); return; }
  closeModalFn(); renderAudit(f,t);
});
function openModal(){ modalBackdrop.style.display='flex'; modalBackdrop.setAttribute('aria-hidden','false'); }
function closeModalFn(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }

/* ======================= CSV Export ======================= */
exportCsvBtn.addEventListener('click', ()=>{
  const tid = state.currentTherapistId;
  if(!tid){ toast('Log in to export', 'warn'); return; }
  const rows = state.entries.filter(e=>e.therapistId===tid);
  if(rows.length===0){ toast('No data to export', 'warn'); return; }
  const header = ['id','date','createdAt','updatedAt','therapistId','therapistName','patientName','clinicEUR','pct','earnedEUR','notes'];
  const csv = [header.join(',')].concat(
    rows.map(e=>[
      e.id,
      e.date,
      e.createdAt||'',
      e.updatedAt||'',
      e.therapistId,
      e.therapistName,
      e.patientName?.replaceAll('"','""')||'',
      e.gross.toFixed(2),
      e.pct.toFixed(2),
      e.earned.toFixed(2),
      (e.notes||'').replaceAll('"','""')
    ].map(v=>`"${String(v)}"`).join(','))
  ).join('\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const tname = (state.therapists[tid]?.name||'therapist').replace(/\s+/g,'_');
  a.href = url; a.download = `ev-fizio-${tname}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

/* ======================= Initial Render ======================= */
(function firstRender(){
  // Set default date & add-form values if therapist known
  if(state.currentTherapistId){ hydrateAddFormDefaults(); }
  else { dateInputEl.value = todayISO(); }
  // Initial audit to something sane
  const rng = getRange('thisMonth'); renderAudit(rng.start, rng.end);
})();
</script>
</body>
</html>
